<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimercado - Dashboard macro</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- ESTILOS GERAIS E PALETA DE CORES --- */
        body {
            background-color: rgb(35, 55, 70); 
            color: #f2f2f2;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }
        
        h2, h3 { color: #ffffff; margin-top: 0; font-weight: 600; letter-spacing: 0.5px; }
        hr { border: 1px solid rgb(120, 135, 145); margin: 20px 0; opacity: 0.3; }
        
        /* --- BARRA LATERAL --- */
        .sidebar {
            background-color: rgb(25, 40, 50); 
            width: 260px; padding: 25px 20px;
            box-shadow: 3px 0 10px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow-y: auto;
            z-index: 10;
        }

        /* --- LOGO --- */
        .logo-container { margin-bottom: 30px; }
        .logo-container img { max-width: 160px; height: auto; display: block; }

        .sidebar label { font-size: 13px; margin-bottom: 6px; display: block; color: rgb(218, 238, 243); font-weight: bold; }
        
        select {
            width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box;
            background-color: rgb(35, 55, 70); color: white; border: 1px solid rgb(120, 135, 145); border-radius: 4px;
            outline: none; font-size: 14px; cursor: pointer;
        }
        select:focus { border-color: rgb(250, 175, 0); }
        
        /* Botões de Ação com o Amarelo Forte */
        .btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        button {
            flex: 1; padding: 8px; background-color: rgb(250, 175, 0); color: #111;
            border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;
            transition: all 0.2s;
        }
        button:hover { background-color: rgb(255, 205, 0); transform: translateY(-1px); }
        
        button.btn-secundario { background-color: rgb(134, 144, 153); color: #fff; }
        button.btn-secundario:hover { background-color: rgb(181, 188, 194); color: #111;}

        /* Lista de Checkboxes */
        .checkbox-list {
            background-color: rgb(35, 55, 70); border: 1px solid rgba(120, 135, 145, 0.4); 
            padding: 12px; border-radius: 6px;
            max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            margin-bottom: 20px;
        }
        .checkbox-list label {
            display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px;
            color: #ddd; margin: 0; transition: color 0.2s; font-weight: normal;
        }
        .checkbox-list label:hover { color: #fff; }
        .checkbox-list input[type="checkbox"] { 
            margin: 0; width: 16px; height: 16px; cursor: pointer; accent-color: rgb(250, 175, 0);
        }

        /* --- CONTEÚDO PRINCIPAL --- */
        .main-content {
            flex-grow: 1; padding: 25px 30px; overflow-y: auto; background-color: rgb(35, 55, 70);
        }
        .chart-container {
            background-color: rgb(25, 40, 50); border-radius: 8px; padding: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(120, 135, 145, 0.1);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgb(25, 40, 50); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgb(120, 135, 145); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(181, 188, 194); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-container">
            <img src="logofator.png" alt="Logo Fator">
        </div>

        <h2 style="margin-bottom: 25px; border-bottom: 2px solid rgb(250, 175, 0); padding-bottom: 10px; display: inline-block;">Filtros</h2>
        
        <label>ATIVO NA TELA:</label>
        <select id="ativoSelect" onchange="processarDadosEAtualizar()"></select>
        
        <hr>

        <label>CICLO PRESIDENCIAL (BR):</label>
        <select id="cicloSelect" onchange="aplicarFiltroCiclo()">
            <option value="livre">Seleção Livre (Manual)</option>
            <option value="eleitoral">Anos Eleitorais</option>
            <option value="pre_eleitoral">Anos Pré-Eleitorais</option>
            <option value="ano1">1º Ano de Governo</option>
            <option value="ano2">2º Ano de Governo</option>
        </select>
        
        <label>ANOS NA AMOSTRA:</label>
        <div class="btn-group">
            <button onclick="selecionarTodosAnos(true)">Todos</button>
            <button class="btn-secundario" onclick="selecionarTodosAnos(false)">Limpar</button>
        </div>
        <div id="anosCheckboxes" class="checkbox-list"></div>

        <hr>

        <label>MÊS DA SAZONALIDADE:</label>
        <select id="mesSelect" onchange="desenharSazonalidade()">
            <option value="1">Janeiro</option><option value="2">Fevereiro</option>
            <option value="3">Março</option><option value="4">Abril</option>
            <option value="5">Maio</option><option value="6">Junho</option>
            <option value="7">Julho</option><option value="8">Agosto</option>
            <option value="9">Setembro</option><option value="10">Outubro</option>
            <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
    </div>

    <div class="main-content">
        <div class="chart-container">
            <h3 id="tituloEvolucao">Evolução Histórica</h3>
            <div id="graficoPrincipal" style="width:100%; height:350px;"></div>
        </div>

        <div class="chart-container">
            <h3 id="tituloSazonalidade">Sazonalidade do Mês</h3>
            <div id="graficoSazonalidade" style="width:100%; height:400px;"></div>
        </div>
    </div>

    <script>
        let dadosBrutos = [];
        let dadosEnriquecidos = []; 
        let anosDisponiveis = [];

        // Cores extraídas da paleta
        const COR_SERIE = 'rgb(250, 175, 0)';
        const COR_FUNDO_GRAFICO = 'rgb(25, 40, 50)';
        const COR_GRID = 'rgba(120, 135, 145, 0.2)';
        const COR_TEXTO = '#ffffff';

        // 1. LÊ O ARQUIVO CSV
        Papa.parse("dados.csv", {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: function(results) {
                dadosBrutos = results.data.filter(row => row.Data); 
                inicializarInterface();
            }
        });

        // 2. CRIA OS BOTÕES E MENUS
        function inicializarInterface() {
            if (dadosBrutos.length === 0) return;

            let colunas = Object.keys(dadosBrutos[0]).filter(k => k !== 'Data');
            let selectAtivo = document.getElementById("ativoSelect");
            colunas.forEach(col => {
                let opt = document.createElement("option");
                opt.value = col; opt.innerHTML = col;
                selectAtivo.appendChild(opt);
            });

            let anosSet = new Set();
            dadosBrutos.forEach(row => {
                anosSet.add(row.Data.substring(0, 4));
            });
            anosDisponiveis = Array.from(anosSet).sort().reverse();

            let divAnos = document.getElementById("anosCheckboxes");
            anosDisponiveis.forEach(ano => {
                let lbl = document.createElement("label");
                // Modificado: ao clicar manualmente num checkbox, reseta o dropdown de ciclo para "Livre"
                lbl.innerHTML = `<input type="checkbox" class="ano-cb" value="${ano}" checked onchange="document.getElementById('cicloSelect').value='livre'; atualizarGraficos()"> <span>${ano}</span>`;
                divAnos.appendChild(lbl);
            });

            processarDadosEAtualizar();
        }

        // NOVO: LÓGICA DO CICLO PRESIDENCIAL
        function aplicarFiltroCiclo() {
            let ciclo = document.getElementById("cicloSelect").value;
            if (ciclo === "livre") return;

            document.querySelectorAll('.ano-cb').forEach(cb => {
                let ano = parseInt(cb.value);
                let marcar = false;

                // Lógica Matemática do Ciclo Brasileiro (Eleições em 1994, 1998, 2002, 2022, etc)
                if (ciclo === "eleitoral") {
                    marcar = (ano % 4 === 2);
                } else if (ciclo === "ano1") {
                    marcar = (ano % 4 === 3);
                } else if (ciclo === "ano2") {
                    marcar = (ano % 4 === 0);
                } else if (ciclo === "pre_eleitoral") {
                    marcar = (ano % 4 === 1);
                }

                cb.checked = marcar;
            });

            atualizarGraficos();
        }

        function atualizarGraficos() {
            desenharEvolucao();
            desenharSazonalidade();
        }

        function selecionarTodosAnos(marcar) {
            // Reseta o dropdown de ciclo ao clicar nos botões Todos/Limpar
            document.getElementById('cicloSelect').value = 'livre';
            document.querySelectorAll('.ano-cb').forEach(cb => cb.checked = marcar);
            atualizarGraficos();
        }

        // 3. FAZ AS CONTAS BÁSICAS
        function processarDadosEAtualizar() {
            let ativo = document.getElementById("ativoSelect").value;
            dadosEnriquecidos = [];
            
            let previousClose = null;
            let currentYear = null;
            let currentMonth = null;
            let tradingDay = 1;

            dadosBrutos.sort((a, b) => a.Data.localeCompare(b.Data));

            for (let i = 0; i < dadosBrutos.length; i++) {
                let row = dadosBrutos[i];
                let close = parseFloat(row[ativo]);
                if (isNaN(close)) continue;

                let partesData = row.Data.split('-');
                let y = parseInt(partesData[0]);
                let m = parseInt(partesData[1]);

                let retorno = previousClose !== null ? (close - previousClose) / previousClose : 0;
                previousClose = close;

                if (y !== currentYear || m !== currentMonth) {
                    tradingDay = 1;
                    currentYear = y; currentMonth = m;
                } else {
                    tradingDay++;
                }

                dadosEnriquecidos.push({
                    Data: row.Data, Ano: y, Mes: m, 
                    TradingDay: tradingDay, Close: close, Retorno: retorno
                });
            }

            atualizarGraficos();
        }

        // 4. DESENHA GRÁFICO 1: EVOLUÇÃO
        function desenharEvolucao() {
            let ativo = document.getElementById("ativoSelect").value;
            let anosSelecionados = Array.from(document.querySelectorAll('.ano-cb:checked')).map(cb => parseInt(cb.value));

            let dadosFiltrados = dadosEnriquecidos.filter(d => anosSelecionados.includes(d.Ano));

            let trace = {
                x: dadosFiltrados.map(d => d.Data),
                y: dadosFiltrados.map(d => d.Close),
                type: 'scatter', mode: 'lines',
                line: {color: COR_SERIE, width: 2},
                fill: 'tozeroy', fillcolor: 'rgba(250, 175, 0, 0.08)',
                name: ativo
            };

            let layout = {
                plot_bgcolor: COR_FUNDO_GRAFICO, paper_bgcolor: COR_FUNDO_GRAFICO, font: {color: COR_TEXTO},
                xaxis: { gridcolor: COR_GRID }, yaxis: { gridcolor: COR_GRID },
                margin: {t: 10, l: 40, r: 20, b: 30},
                hovermode: 'x unified'
            };

            Plotly.newPlot('graficoPrincipal', [trace], layout);
        }

        // 5. DESENHA GRÁFICO 2: SAZONALIDADE LIMPO E AUTOMÁTICO
        function desenharSazonalidade() {
            let mes = parseInt(document.getElementById("mesSelect").value);
            let anosSelecionados = Array.from(document.querySelectorAll('.ano-cb:checked')).map(cb => parseInt(cb.value));
            
            let dadosMes = dadosEnriquecidos.filter(d => d.Mes === mes && anosSelecionados.includes(d.Ano));

            if (dadosMes.length === 0) {
                Plotly.purge('graficoSazonalidade'); 
                return;
            }

            let dadosPorAno = {};
            dadosMes.forEach(d => {
                if(!dadosPorAno[d.Ano]) dadosPorAno[d.Ano] = [];
                dadosPorAno[d.Ano].push(d);
            });

            let anos = Object.keys(dadosPorAno).map(Number);
            let anoAtual = Math.max(...anosDisponiveis.map(Number)); 
            let traces = [];
            let somaRetornosPorDia = {}; 

            anos.forEach(ano => {
                let dadosDoAno = dadosPorAno[ano];
                let x = []; let y = []; let retornoAcumulado = 0;

                dadosDoAno.forEach(d => {
                    retornoAcumulado += (d.Retorno * 100);
                    x.push(d.TradingDay);
                    y.push(retornoAcumulado);

                    if(!somaRetornosPorDia[d.TradingDay]) somaRetornosPorDia[d.TradingDay] = [];
                    somaRetornosPorDia[d.TradingDay].push(d.Retorno);
                });

                if (ano === anoAtual && anosSelecionados.includes(anoAtual)) {
                    traces.push({
                        x: x, y: y, type: 'scatter', mode: 'lines+markers',
                        line: {color: COR_SERIE, width: 3},
                        marker: {size: 6},
                        name: `Ano Atual (${ano})`
                    });
                }
            });

            let maxDias = Math.max(...Object.keys(somaRetornosPorDia).map(Number));
            let xAvg = []; let yAvg = []; let mediaAcumulada = 0;

            for(let i=1; i<=maxDias; i++) {
                if(somaRetornosPorDia[i]) {
                    let rets = somaRetornosPorDia[i];
                    let mediaDiaria = rets.reduce((a,b) => a+b, 0) / rets.length;
                    mediaAcumulada += (mediaDiaria * 100);
                    xAvg.push(i);
                    yAvg.push(mediaAcumulada);
                }
            }

            traces.push({
                x: xAvg, y: yAvg, type: 'scatter', mode: 'lines',
                line: {color: 'rgb(242, 242, 242)', width: 3, dash: 'dot'},
                name: 'Média da Amostra'
            });

            traces.push({
                x: [1, maxDias], y: [0, 0], type: 'scatter', mode: 'lines',
                line: {color: 'rgba(255,255,255,0.3)', width: 1},
                hoverinfo: 'none', showlegend: false
            });

            let layout = {
                plot_bgcolor: COR_FUNDO_GRAFICO, paper_bgcolor: COR_FUNDO_GRAFICO, font: {color: COR_TEXTO},
                xaxis: { title: 'Dia Útil do Mês', gridcolor: COR_GRID },
                yaxis: { title: 'Retorno Acumulado (%)', gridcolor: COR_GRID, zeroline: false },
                margin: {t: 10, l: 40, r: 20, b: 40}, hovermode: 'x unified',
                legend: { orientation: 'h', y: 1.1, x: 0 } 
            };

            Plotly.newPlot('graficoSazonalidade', traces, layout);
        }
    </script>
</body>
</html>
